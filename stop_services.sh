#!/bin/bash

# Configurable ports (must match what was used in run_services.sh)
BACKEND_PORT=${BACKEND_PORT:-8081}
FRONTEND_PORT=${FRONTEND_PORT:-8080}
DOCS_PORT=${DOCS_PORT:-8082}

echo "Stopping services..."

# Stop FastAPI server
PIDS=$(lsof -t -i:${BACKEND_PORT} 2>/dev/null)
if [ -n "$PIDS" ]; then
    echo "$PIDS" | xargs kill 2>/dev/null
    sleep 1
    # Force kill any survivors (uvicorn reload workers can ignore SIGTERM)
    PIDS=$(lsof -t -i:${BACKEND_PORT} 2>/dev/null)
    [ -n "$PIDS" ] && echo "$PIDS" | xargs kill -9 2>/dev/null
    echo "Stopped FastAPI server (${BACKEND_PORT})"
else
    echo "FastAPI server (${BACKEND_PORT}) not running"
fi

# Stop FastAPI server (port 8000)
PIDS=$(lsof -t -i:8000 2>/dev/null)
if [ -n "$PIDS" ]; then
    echo "$PIDS" | xargs kill 2>/dev/null
    sleep 1
    PIDS=$(lsof -t -i:8000 2>/dev/null)
    [ -n "$PIDS" ] && echo "$PIDS" | xargs kill -9 2>/dev/null
    echo "Stopped service on port 8000"
else
    echo "Port 8000 not in use"
fi

# Stop website
if pkill -f "next dev.*-p ${FRONTEND_PORT}" 2>/dev/null || pkill -f "npm run dev" 2>/dev/null; then
    echo "Stopped website (${FRONTEND_PORT})"
else
    echo "Website (${FRONTEND_PORT}) not running"
fi

# Stop mkdocs
pkill -f "mkdocs serve" && echo "Stopped mkdocs" || echo "MkDocs not running"

echo "All services stopped."
