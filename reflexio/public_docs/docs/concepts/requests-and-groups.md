# Requests and Request Groups

## Overview

Requests and request groups are the organizational foundation of Reflexio, enabling structured tracking and bulk operations on user interactions.

## What is a Request?

A **Request** is a container for one or more interactions that provides essential metadata and organizational context. Every time you publish interactions using `publish_interaction()`, Reflexio creates a Request object that wraps those interactions.

### Request Structure

Each Request contains:

- **`request_id`**: Unique identifier (UUID) automatically generated by the server
- **`user_id`**: The user associated with this request
- **`source`**: Where the interaction came from (e.g., "web_app", "mobile_app", "api")
- **`agent_version`**: Version of your agent that generated this interaction
- **`request_group`**: Optional string to group related requests together
- **`created_at`**: Timestamp when the request was created

### Why Requests Matter

Requests provide:
- **Attribution**: Track which agent version or source generated which interactions
- **Organization**: Group related interactions together
- **Bulk Operations**: Delete all interactions from a request at once

## Request Groups

**Request groups** are logical groupings of related requests that belong to the same conversation or session. They serve a critical role in providing context for profile and feedback extraction.

### Why Request Groups Matter

When Reflexio processes interactions for profile extraction or feedback generation, it uses the request group to understand the broader context. All requests within the same request group are considered part of the same conversation, allowing the system to:

- **Extract more accurate profiles** - Understanding the full conversation context leads to better profile extraction
- **Generate contextual feedback** - Feedback generation can consider the entire session flow
- **Maintain conversation continuity** - Related requests are linked together for analysis

### Use Cases

#### 1. Conversation/Session Tracking

Group all requests within a user conversation or session:

```python
session_id = "session_xyz"

# Multiple interactions in the same session
for interaction in session_interactions:
    client.publish_interaction(
        user_id="user_123",
        interactions=[interaction],
        request_group=session_id
    )
```

#### 2. Multi-Turn Conversation Tracking

Publish multiple turns of a conversation under the same request group for better context:

```python
conversation_id = "conv_20241215_001"

# First turn
client.publish_interaction(
    user_id="user_123",
    interactions=[
        {"role": "User", "content": "I need help with my order"},
        {"role": "Agent", "content": "I'd be happy to help! What's your order number?"}
    ],
    request_group=conversation_id,
    agent_version="v1.0"
)

# Second turn (same conversation)
client.publish_interaction(
    user_id="user_123",
    interactions=[
        {"role": "User", "content": "Order #12345"},
        {"role": "Agent", "content": "I found your order. It's currently being shipped."}
    ],
    request_group=conversation_id,
    agent_version="v1.0"
)
```

#### 3. Bulk Cleanup

Delete all requests from a session or conversation at once:

```python
# After session concludes, clean up all data
client.delete_request_group(
    request_group="session_001",
    wait_for_response=True
)
```

## Workflow Example

Here's a complete workflow showing how requests and request groups work together:

```python
from reflexio import ReflexioClient

client = ReflexioClient(api_key="your_api_key")

# Step 1: Publish interaction
client.publish_interaction(
    user_id="user_456",
    interactions=[
        {"content": "User asks a question", "role": "user"},
        {"content": "Agent response", "role": "assistant"}
    ],
    request_group="session_001",
    agent_version="v2.0",
    source="web_app"
)

# Step 2: Retrieve all requests for the user
requests = client.get_requests(user_id="user_456")

# Step 3: Analyze requests
for request_group in requests.request_groups:
    print(f"Request Group: {request_group.request_group}")
    for request_data in request_group.requests:
        print(f"  Request ID: {request_data.request.request_id}")
        print(f"  Agent Version: {request_data.request.agent_version}")
        print(f"  Interactions: {len(request_data.interactions)}")

# Step 4: Clean up after analysis
client.delete_request_group(
    request_group="session_001",
    wait_for_response=True
)
```

## Best Practices

### 1. Use Descriptive Request Group Names

```python
# Good: Clear, descriptive names
request_group="2024_q1_session_001"
request_group="onboarding_flow_v3"

# Avoid: Generic or unclear names
request_group="test1"
request_group="experiment"
```

### 2. Track Agent Versions

Always specify `agent_version` to track which version generated each request:

```python
client.publish_interaction(
    user_id="user_123",
    interactions=[...],
    agent_version="v2.1.0",  # Clear version tracking
    request_group="session_001"
)
```

### 3. Clean Up Completed Sessions

Delete request groups when they are no longer needed to manage storage:

```python
# After analysis is complete
client.delete_request_group(
    request_group="old_session_001",
    wait_for_response=True
)
```

### 4. Use Source for Attribution

Track where interactions came from:

```python
client.publish_interaction(
    user_id="user_123",
    interactions=[...],
    source="mobile_app",  # or "web_app", "api", etc.
    request_group="session_001"
)
```

## Related Concepts

- **[Interactions](./interactions.md)**: The individual data points contained within requests
- **[User Profiles](./user-profiles.md)**: Generated from requests
- **[Agent Feedback](./agent-feedback.md)**: Generated from requests

## API Reference

- [`publish_interaction()`](../api-reference/client.md#publish_interaction): Create requests with interactions
- [`get_requests()`](../api-reference/client.md#get_requests): Retrieve requests grouped by request_group
- [`delete_request()`](../api-reference/client.md#delete_request): Delete a single request
- [`delete_request_group()`](../api-reference/client.md#delete_request_group): Delete all requests in a group

## Examples

See [Request Management Examples](../examples/request-management.md) for detailed code examples.
